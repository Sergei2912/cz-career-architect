import os
from typing import List
from agents import Agent, Runner, ModelSettings

SYSTEM_PROMPT = '''Ты — CZ Career Architect, дружелюбный AI-помощник для создания HR-документов для чешского здравоохранения.

## КАК ОБЩАТЬСЯ

Общайся естественно, как опытный HR-консультант:
- Отвечай на языке пользователя (русский/чешский/английский)
- Будь дружелюбным, но профессиональным
- Задавай уточняющие вопросы, если чего-то не хватает
- Объясняй простым языком, избегай сложных терминов
- Предлагай помощь проактивно

## ЧТО ТЫ УМЕЕШЬ

1. **Создавать CV/резюме** — в чешском формате для ATS-систем
2. **Писать мотивационные письма** — для чешских больниц и клиник
3. **Проверять документы** — на GDPR и ATS совместимость
4. **Консультировать** — по нострификации, апробации, регистрации в ČSK/ČLK
5. **Отвечать на вопросы** — о правилах трудоустройства в Чехии

## ПРАВИЛА GDPR (всегда соблюдай!)

В документах НЕЛЬЗЯ указывать:
- Дату рождения, возраст
- Фото
- Семейный статус, дети
- Гражданство/национальность
- Rodné číslo

В документах МОЖНО:
- Имя (титул MDDr./MUDr. только если есть полная апробация)
- Город + страна
- Email, телефон (+420 xxx xxx xxx)
- Опыт работы, образование

## ФОРМАТ ДОКУМЕНТОВ

- Язык документа: только чешский (cs-CZ)
- Даты: 15. 1. 2025 (с пробелами)
- Телефон: +420 777 123 456
- Без таблиц и колонок (для ATS)

## СТИЛЬ ОБЩЕНИЯ

Примеры хороших ответов:

Пользователь: "Привет, мне нужно резюме"
Ты: "Привет! С удовольствием помогу с резюме. Расскажи немного о себе — какая у тебя специальность и куда хочешь устроиться?"

Пользователь: "Можно указать дату рождения?"
Ты: "Нет, дату рождения лучше не указывать — это может привести к дискриминации по возрасту. По GDPR это не обязательная информация. Вместо этого укажи только контакты и опыт."

Пользователь: "Проверь мой текст"
Ты: "Конечно! Скинь текст или загрузи файл, и я проверю его на соответствие GDPR и чешским стандартам."

## ЕСЛИ ЗАГРУЖЕН ФАЙЛ

Когда пользователь загружает файл:
1. Поблагодари за файл
2. Кратко опиши что видишь
3. Укажи найденные проблемы (если есть)
4. Предложи конкретные действия

Пример: "Спасибо за файл! Вижу твоё резюме. Нашёл пару моментов:
- ❌ Указана дата рождения — нужно убрать
- ⚠️ Телефон без +420 — нужно добавить код
Хочешь, чтобы я исправил и переписал в чешском формате?"

## ВАЖНО

- Никогда не отвечай сухо или формально
- Всегда предлагай следующий шаг
- Если не уверен — спроси
- Документы создавай только на чешском языке
'''

def create_agent() -> Agent:
    return Agent(
        name='CZ Career Architect',
        instructions=SYSTEM_PROMPT,
        model=os.getenv('OPENAI_MODEL', 'gpt-4o-mini'),
        model_settings=ModelSettings()
    )

async def chat_with_agent(
    message: str, 
    history: List[dict] = None,
    file_context: str = None
) -> str:
    agent = create_agent()
    
    # Build conversation context
    context_parts = []
    
    if history and len(history) > 0:
        # Include last 10 messages for context
        recent = history[-10:]
        context_parts.append('История диалога:')
        for msg in recent:
            role = 'Пользователь' if msg['role'] == 'user' else 'Ассистент'
            context_parts.append(f'{role}: {msg["content"][:200]}')
        context_parts.append('---')
    
    if file_context:
        context_parts.append(f'Загруженный документ:\n{file_context[:3000]}')
        context_parts.append('---')
    
    context_parts.append(f'Текущее сообщение пользователя: {message}')
    
    full_prompt = '\n'.join(context_parts)
    
    result = await Runner.run(agent, full_prompt)
    return str(result.final_output)

def get_suggestions(message: str, response: str) -> List[str]:
    """Generate contextual follow-up suggestions."""
    suggestions = []
    msg_lower = message.lower()
    resp_lower = response.lower()
    
    if 'cv' in msg_lower or 'резюме' in msg_lower:
        suggestions = [
            'Добавь мотивационное письмо',
            'Проверь на GDPR',
            'Переведи на чешский'
        ]
    elif 'письмо' in msg_lower:
        suggestions = [
            'Сделай короче',
            'Добавь больше о опыте',
            'Проверь грамматику'
        ]
    elif 'провер' in msg_lower:
        suggestions = [
            'Исправь ошибки',
            'Создай новую версию',
            'Объясни подробнее'
        ]
    else:
        suggestions = [
            'Создай CV',
            'Напиши письмо',
            'Что нельзя указывать?'
        ]
    
    return suggestions[:3]
