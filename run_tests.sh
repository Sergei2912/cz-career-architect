#!/bin/bash

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CZ Career Architect - Test Runner Script
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Ğ­Ñ‚Ğ¾Ñ‚ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ Ğ·Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµÑÑ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°.
# Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:
#   ./run_tests.sh           - Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ñ‚ĞµÑÑ‚Ñ‹
#   ./run_tests.sh coverage  - Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ñ Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ğ¸ĞµĞ¼ ĞºĞ¾Ğ´Ğ°
#   ./run_tests.sh quick     - Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ±ĞµĞ· verbose
#   ./run_tests.sh file <name> - Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ»
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -e  # Ğ’Ñ‹Ğ¹Ñ‚Ğ¸ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ

# Ğ¦Ğ²ĞµÑ‚Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ°
print_header() {
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}  CZ Career Architect - Test Runner${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

print_success() {
    echo -e "${GREEN}âœ“${NC} $1"
}

print_error() {
    echo -e "${RED}âœ—${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}âš ${NC} $1"
}

print_info() {
    echo -e "${BLUE}â„¹${NC} $1"
}

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸
check_directory() {
    print_info "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸..."
    
    if [ ! -d "tests" ] || [ ! -d "base_for_agent_cv" ]; then
        print_error "ĞÑˆĞ¸Ğ±ĞºĞ°: Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ¸Ğ· ĞºĞ¾Ñ€Ğ½Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°!"
        echo ""
        echo "Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ: $(pwd)"
        echo ""
        echo "ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾:"
        echo "  cd /path/to/cz-career-architect"
        echo "  ./run_tests.sh"
        echo ""
        exit 1
    fi
    
    print_success "Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ: $(pwd)"
}

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Python
check_python() {
    print_info "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Python..."
    
    if ! command -v python &> /dev/null && ! command -v python3 &> /dev/null; then
        print_error "Python Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½! Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ Python 3.9+"
        exit 1
    fi
    
    # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ python
    if command -v python3 &> /dev/null; then
        PYTHON_CMD="python3"
    else
        PYTHON_CMD="python"
    fi
    
    PYTHON_VERSION=$($PYTHON_CMD --version 2>&1 | awk '{print $2}')
    print_success "Python ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½: $PYTHON_VERSION"
}

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
check_venv() {
    if [ -d "venv" ] && [ -z "$VIRTUAL_ENV" ]; then
        print_warning "ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ, Ğ½Ğ¾ Ğ¾Ğ½Ğ¾ Ğ½Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾"
        print_info "ĞĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ñ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ..."
        
        if [ -f "venv/bin/activate" ]; then
            source venv/bin/activate
            print_success "Ğ’Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾"
        elif [ -f "venv/Scripts/activate" ]; then
            source venv/Scripts/activate
            print_success "Ğ’Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾"
        fi
    elif [ -n "$VIRTUAL_ENV" ]; then
        print_success "Ğ’Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾: $VIRTUAL_ENV"
    fi
}

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
check_dependencies() {
    print_info "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹..."
    
    if ! $PYTHON_CMD -c "import pytest" 2>/dev/null; then
        print_error "pytest Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½!"
        echo ""
        read -p "Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ÑĞµĞ¹Ñ‡Ğ°Ñ? (y/n) " -n 1 -r
        echo ""
        
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            print_info "Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹..."
            $PYTHON_CMD -m pip install -r requirements.txt
            print_success "Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹"
        else
            print_error "ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ğ±ĞµĞ· pytest"
            echo "Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ:"
            echo "  pip install -r requirements.txt"
            exit 1
        fi
    else
        print_success "Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹"
    fi
}

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
check_environment() {
    print_info "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ..."
    
    if [ -z "$OPENAI_API_KEY" ]; then
        print_warning "OPENAI_API_KEY Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"
        print_info "ĞĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ¸"
        
        if [ -f ".env" ]; then
            print_info "ĞĞ°Ğ¹Ğ´ĞµĞ½ Ñ„Ğ°Ğ¹Ğ» .env - Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ…..."
            export $(cat .env | grep -v '^#' | xargs)
            
            if [ -n "$OPENAI_API_KEY" ]; then
                print_success "OPENAI_API_KEY Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½ Ğ¸Ğ· .env"
            fi
        else
            print_info "Ğ¡Ğ¾Ğ²ĞµÑ‚: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ» .env Ñ OPENAI_API_KEY"
        fi
    else
        print_success "OPENAI_API_KEY ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"
    fi
}

# Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµÑÑ‚Ğ¾Ğ²
run_tests() {
    local mode=$1
    local test_arg=$2
    
    echo ""
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµÑÑ‚Ğ¾Ğ²...${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    case $mode in
        "coverage")
            print_info "Ğ ĞµĞ¶Ğ¸Ğ¼: Ğ¢ĞµÑÑ‚Ñ‹ Ñ Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ğ¸ĞµĞ¼ ĞºĞ¾Ğ´Ğ°"
            $PYTHON_CMD -m pytest tests/ \
                --cov=base_for_agent_cv \
                --cov-report=term-missing \
                --cov-report=html \
                -v
            
            echo ""
            print_success "HTML Ğ¾Ñ‚Ñ‡ĞµÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½: htmlcov/index.html"
            ;;
            
        "quick")
            print_info "Ğ ĞµĞ¶Ğ¸Ğ¼: Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº"
            $PYTHON_CMD -m pytest tests/ -q
            ;;
            
        "file")
            if [ -z "$test_arg" ]; then
                print_error "Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ Ñ„Ğ°Ğ¹Ğ»Ğ° Ñ‚ĞµÑÑ‚Ğ°"
                echo "ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: ./run_tests.sh file test_config"
                exit 1
            fi
            
            print_info "Ğ ĞµĞ¶Ğ¸Ğ¼: Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ„Ğ°Ğ¹Ğ»Ğ° tests/${test_arg}.py"
            
            if [ -f "tests/${test_arg}.py" ]; then
                $PYTHON_CMD -m pytest "tests/${test_arg}.py" -v
            elif [ -f "tests/${test_arg}" ]; then
                $PYTHON_CMD -m pytest "tests/${test_arg}" -v
            else
                print_error "Ğ¤Ğ°Ğ¹Ğ» Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½: tests/${test_arg}.py"
                exit 1
            fi
            ;;
            
        *)
            print_info "Ğ ĞµĞ¶Ğ¸Ğ¼: Ğ’ÑĞµ Ñ‚ĞµÑÑ‚Ñ‹"
            $PYTHON_CMD -m pytest tests/ -v
            ;;
    esac
    
    local exit_code=$?
    
    echo ""
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    
    if [ $exit_code -eq 0 ]; then
        print_success "Ğ¢ĞµÑÑ‚Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ñ‹!"
    else
        print_error "Ğ¢ĞµÑÑ‚Ñ‹ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ğ»Ğ¸ÑÑŒ Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ğ¼Ğ¸"
        exit $exit_code
    fi
    
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
}

# Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ
main() {
    print_header
    
    # ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ
    echo -e "ğŸ“‚ Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ: ${GREEN}$(pwd)${NC}"
    echo ""
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
    check_directory
    check_python
    check_venv
    check_dependencies
    check_environment
    
    # Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµÑÑ‚Ğ¾Ğ²
    local mode=${1:-"default"}
    local test_arg=$2
    
    run_tests "$mode" "$test_arg"
}

# ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ½Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞ¸
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo "CZ Career Architect - Test Runner"
    echo ""
    echo "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:"
    echo "  ./run_tests.sh              Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ñ‚ĞµÑÑ‚Ñ‹"
    echo "  ./run_tests.sh coverage     Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ñ Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ğ¸ĞµĞ¼ ĞºĞ¾Ğ´Ğ°"
    echo "  ./run_tests.sh quick        Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ±ĞµĞ· verbose"
    echo "  ./run_tests.sh file <name>  Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ»"
    echo ""
    echo "ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹:"
    echo "  ./run_tests.sh"
    echo "  ./run_tests.sh coverage"
    echo "  ./run_tests.sh file test_config"
    echo ""
    echo "Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:"
    echo "  - Python 3.9+"
    echo "  - pip install -r requirements.txt"
    echo "  - Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¸Ğ· ĞºĞ¾Ñ€Ğ½Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°"
    echo ""
    exit 0
fi

# Ğ—Ğ°Ğ¿ÑƒÑĞº
main "$@"
